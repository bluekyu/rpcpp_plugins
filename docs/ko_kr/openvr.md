# OpenVR
**Translation**: [English](../openvr.md)

## 개요
OpenVR (https://github.com/ValveSoftware/openvr) 라이브러리를 위한 플러그인이다. OpenVR 플러그인이 활성화 되어 있으면,
플러그인 로드 단계에서 OpenVR 를 초기화 한다. 그리고 OpenVRRenderStage 에서 마지막에 그려진 화면을 OpenVR texture 에 복사하고,
매 프레임 마지막 단계에서 해당 texture 를 HMD 에 보낸다.

## 사용법
Render Pipeline C++ 의 [스테레오 및 가상현실](https://github.com/bluekyu/render_pipeline_cpp/blob/master/docs/ko_kr/rendering/stereo-and-vr.md) 문서 참고.

## 내부 기능
### 거리 단위 및 렌더링 스케일
OpenVR 에서는 미터 단위를 사용하므로, 렌더링 단위와 맞지 않을 경우 스케일링이 필요하다.
플러그인에서는 config 설정에 있는 `distance_scale` 설정을 사용하여 이를 자동으로 조절한다.
예를 들어 기본값은 5 이고, 1 meter 는 렌더링 시에 5 유닛으로 사용된다.

코드 상에서는 `OpenVRPlugin::set_distance_scale` 함수를 통해서 조절이 가능하고,
이 값은 카메라 노드의 위치 조절과 "device_node_group" 노드의 스케일 값에 반영된다.
따라서 각 device node 들은 OpenVR 의 원래 값을 그대로 사용하므로 미터 단위를 가지며, 월드 좌표계에서
distance_scale 만큼 스케일링 된다.



## 최적화

### CPU 및 GPU 리소스 배분
OpenVR 에서는 (Vive의 경우) 90Hz 의 동기화를 필요로 하는데, 동기화를 수행하는 시점은 OpenVR 장치들의 위치를
새로 구하는 시점(`vr::IVRCompositor::WaitGetPoses`) 이다.
이 시점에서 이전에 submit 한 텍스처가 완료되기를 기다리며, 작업이 끝나면 새로운 위치를 계산해서 넘겨준다.

OpenVR 플러그인에서는 -50 sort 값(`OpenVRPlugin::UPDATE_TASK_SORT`)을 갖는
`OpenVRPlugin::Impl::wait_get_poses` 단계에서 이를 수행한다.
따라서 게임 로직이 -50 이후에 수행된다면, wait_get_poses 시점에서
약 4~5 ms (Render Pipeline 플러그인들의 활성화 여부에 따라 다름) 정도의 대기(stall)가 발생한다.

```
    +----------+---------+--------------+---------+----------+
CPU | T1 (N+1) | S (N+1) |   T2 (N+1)   | R (N+1) | T1 (N+2) |
    +----------+---------+--------------+---------+----------+
                         ↑                    ↘
    +--------------------+---------------+--------------------+
GPU |        R (N)       |               |       R (N+1)      |
    +--------------------+---------------+--------------------+
```
(GPU의 N 프레임 렌더링이 끝나기 전까지 CPU 에서는 대기(S)가 발생한다.)

참고로, 일반적인 Panda3D 에서 게임 로직을 렌더링에 반영하는 시점(동기화 시점)은 50 sort 값을 갖는 `task_igloop` 의
초기 단계에서 수행된다. (즉, SwapBuffers 시점)
그러므로 GPU 렌더링이 수행되는 동안 게임 로직을 업데이트할 수 있는 여유 시간을 가질 수 있다.

```
    +------------------------+---------+------------------------+
CPU |         T (N+1)        | R (N+1) |         T (N+2)        |
    +------------------------+---------+------------------------+
                         ↑        ↘
    +--------------------+----+--------------------+
GPU |        R (N)       |    |        R (N+1)     |
    +--------------------+----+--------------------+
```
(GPU의 N 프레임 렌더링 동안 전까지 CPU 에서 task (T)를 처리할 수 있다.)

만일, OpenVR 장치들의 위치를 직접 필요로 하는 부분(절대 좌표 등)이 없다면, 이러한 작업들을 -50 sort 이전으로
설정하면 VR 렌더링 동안 CPU 작업을 처리할 수 있도록 자원을 배분할 수 있다.
